{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Reorder and Split</title>
    <link rel="stylesheet" href="{% static 'style.css' %}">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <style>
    .drop-area {
      border: 2px dashed #ccc;
      padding: 20px;
      text-align: center;
      margin-bottom: 20px;
    }
    .drop-area.dragover {
      border-color: #000;
      background-color: #f9f9f9;
    }
    .page-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 10px;
    }
    .page {
      border: 1px solid #ccc;
      position: relative;
      overflow: hidden;
    }
    .page img {
      width: 100%;
      display: block;
    }
    .delete-button {
      position: absolute;
      top: 5px;
      right: 5px;
      background: red;
      color: white;
      border: none;
      border-radius: 50%;
      cursor: pointer;
    }
    .controls {
      margin-bottom: 20px;
    }
    .controls button {
      margin-right: 10px;
    }
  </style>
</head>
<body>
  <div class="drop-area" id="dropArea">
    Drag and drop PDF files here
  </div>
  <div class="controls">
    <button onclick="zoomIn()">Zoom In</button>
    <button onclick="zoomOut()">Zoom Out</button>
    <button onclick="downloadReordered()">Download Reordered PDF</button>
    <button onclick="downloadAsZip()">Download All as ZIP</button>
  </div>
  <div class="page-container" id="pageContainer"></div>

  <script>
    let pages = [];
    let zoom = 1;

    const dropArea = document.getElementById('dropArea');

    // Highlight drop area on dragover
    dropArea.addEventListener('dragover', (event) => {
      event.preventDefault();
      dropArea.classList.add('dragover');
    });

    dropArea.addEventListener('dragleave', () => {
      dropArea.classList.remove('dragover');
    });

    dropArea.addEventListener('drop', handleDrop);

    async function handleDrop(event) {
      event.preventDefault();
      dropArea.classList.remove('dragover');

      const files = Array.from(event.dataTransfer.files).filter(file => file.type === "application/pdf");

      if (files.length === 0) {
        console.error('No valid PDF files found.');
        return;
      }

      console.log('Dropped files:', files);

      for (const file of files) {
        try {
          const arrayBuffer = await file.arrayBuffer();
          const pdfDoc = await PDFLib.PDFDocument.load(arrayBuffer);
          const pageCount = pdfDoc.getPageCount();

          console.log(`Processing ${file.name}, pages: ${pageCount}`);

          for (let i = 0; i < pageCount; i++) {
            const singlePagePdf = await PDFLib.PDFDocument.create();
            const [copiedPage] = await singlePagePdf.copyPages(pdfDoc, [i]);
            singlePagePdf.addPage(copiedPage);
            const singlePageBytes = await singlePagePdf.save();
            const blob = new Blob([singlePageBytes], { type: "application/pdf" });
            const url = URL.createObjectURL(blob);

            pages.push({ blob, url });
          }
        } catch (error) {
          console.error('Error processing file:', file.name, error);
        }
      }
      renderPages();
    }

    function renderPages() {
      const container = document.getElementById('pageContainer');
      container.innerHTML = '';

      pages.forEach((page, index) => {
        const pageElement = document.createElement('div');
        pageElement.classList.add('page');
        pageElement.style.transform = `scale(${zoom})`;

        const img = document.createElement('img');
        img.src = page.url;
        pageElement.appendChild(img);

        const deleteButton = document.createElement('button');
        deleteButton.textContent = 'âœ•';
        deleteButton.classList.add('delete-button');
        deleteButton.onclick = () => deletePage(index);
        pageElement.appendChild(deleteButton);

        container.appendChild(pageElement);
      });
    }

    function deletePage(index) {
      pages.splice(index, 1);
      renderPages();
    }

    function zoomIn() {
      zoom += 0.1;
      renderPages();
    }

    function zoomOut() {
      zoom = Math.max(0.1, zoom - 0.1);
      renderPages();
    }

    async function downloadReordered() {
      const pdfDoc = await PDFLib.PDFDocument.create();

      for (const page of pages) {
        const pdfBytes = await page.blob.arrayBuffer();
        const loadedDoc = await PDFLib.PDFDocument.load(pdfBytes);
        const [copiedPage] = await pdfDoc.copyPages(loadedDoc, [0]);
        pdfDoc.addPage(copiedPage);
      }

      const mergedBytes = await pdfDoc.save();
      const blob = new Blob([mergedBytes], { type: "application/pdf" });
      saveAs(blob, 'reordered.pdf');
    }

    async function downloadAsZip() {
      const zip = new JSZip();

      for (let i = 0; i < pages.length; i++) {
        const pdfBytes = await pages[i].blob.arrayBuffer();
        zip.file(`page-${i + 1}.pdf`, pdfBytes);
      }

      const zipBlob = await zip.generateAsync({ type: 'blob' });
      saveAs(zipBlob, 'pages.zip');
    }
  </script>
</body>
</html>



